<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <meta name="description" content="Your custom AI-generated horror games">
    <meta name="robots" content="noindex, nofollow">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Custom Games ‚Äî ScaryGamesAI">
    <meta property="og:description" content="Play your custom AI-generated horror games">
    <title>Custom Games ‚Äî ScaryGamesAI</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/ollama-builder.css">
    <link rel="manifest" href="/manifest.json">
</head>

<body>
    <!-- Skip link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <div class="bg-fog"></div>
    <div class="bg-grain"></div>

    <sgai-navbar></sgai-navbar>

    <main class="main-content" id="main-content" role="main">
        <section class="container">
            <div class="section-header">
                <h2>Custom Games</h2>
                <p>Your AI-generated horror games</p>
            </div>

            <!-- Access Check -->
            <div id="access-check"></div>

            <!-- Games Content -->
            <div id="games-content" style="display: none;">
                <!-- Quick Actions -->
                <div class="quick-actions">
                    <button class="quick-action-btn" id="select-mode-btn">
                        <span>‚òëÔ∏è</span> Select
                    </button>
                    <button class="quick-action-btn" id="new-game-btn">
                        <span>‚ú®</span> New Game
                    </button>
                    <button class="quick-action-btn" id="help-btn">
                        <span>‚ùì</span> Help
                    </button>
                </div>

                <!-- Bulk Actions (hidden by default) -->
                <div class="bulk-actions" id="bulk-actions" style="display: none;">
                    <span class="bulk-actions-text">
                        <span class="selection-badge" id="selection-count">0</span> games selected
                    </span>
                    <button class="bulk-btn" id="bulk-delete-btn">Delete Selected</button>
                    <button class="bulk-btn" id="bulk-category-btn">Change Category</button>
                    <button class="bulk-cancel" id="bulk-cancel-btn">Cancel</button>
                </div>

                <!-- Filter Bar -->
                <div class="filter-bar">
                    <div class="search-wrapper">
                        <span class="search-icon">üîç</span>
                        <input type="text" class="search-input" id="search-input" placeholder="Search games...">
                    </div>
                    <select class="filter-select" id="category-filter">
                        <option value="all">All Categories</option>
                        <option value="uncategorized">Uncategorized</option>
                    </select>
                    <div class="sort-dropdown">
                        <button class="sort-btn" id="sort-btn">
                            <span>Sort: <span id="current-sort">Newest</span></span>
                            <span>‚ñº</span>
                        </button>
                        <div class="sort-menu" id="sort-menu">
                            <button class="sort-option active" data-sort="created" data-order="desc">Newest First</button>
                            <button class="sort-option" data-sort="created" data-order="asc">Oldest First</button>
                            <button class="sort-option" data-sort="title" data-order="asc">Alphabetical A-Z</button>
                            <button class="sort-option" data-sort="title" data-order="desc">Alphabetical Z-A</button>
                            <button class="sort-option" data-sort="played" data-order="desc">Most Played</button>
                            <button class="sort-option" data-sort="score" data-order="desc">Highest Score</button>
                            <button class="sort-option" data-sort="updated" data-order="desc">Recently Updated</button>
                        </div>
                    </div>
                </div>

                <!-- Category Chips -->
                <div class="category-manager" id="category-chips">
                    <!-- Populated by JavaScript -->
                </div>

                <!-- Games Grid -->
                <div class="custom-games-grid" id="custom-games-grid">
                    <!-- Populated by JavaScript -->
                </div>

                <!-- Empty State -->
                <div class="empty-state" id="empty-state" style="display: none;">
                    <div class="empty-illustration">üéÆ</div>
                    <h3>No Custom Games Yet</h3>
                    <p>Use the Ollama Game Builder to create your first AI-generated horror game!</p>
                    <a href="/ollama-builder.html" class="create-btn">
                        <span>Create Game</span>
                        <span>‚ú®</span>
                    </a>
                </div>

                <!-- No Results State -->
                <div class="empty-state" id="no-results" style="display: none;">
                    <div class="empty-illustration">üîç</div>
                    <h3>No Games Found</h3>
                    <p>Try adjusting your search or filters.</p>
                    <button class="create-btn" id="clear-filters-btn">
                        <span>Clear Filters</span>
                    </button>
                </div>
            </div>
        </section>
    </main>

    <sgai-footer></sgai-footer>

    <!-- Game Player -->
    <div class="game-player-container" id="game-player" style="display: none;">
        <div class="game-player-header">
            <span class="game-player-title" id="player-title">Custom Game</span>
            <button class="game-player-close" id="player-close">Exit Game</button>
        </div>
        <iframe class="game-player-frame" id="game-frame" src=""></iframe>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="delete-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Delete Game?</h3>
                <button class="modal-close" id="delete-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete "<span id="delete-game-name"></span>"? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="delete-cancel-btn">Cancel</button>
                <button class="btn-delete" id="delete-confirm-btn" style="background: #cc1122; border-color: #cc1122; color: #fff;">Delete</button>
            </div>
        </div>
    </div>

    <!-- Bulk Delete Modal -->
    <div class="modal-overlay" id="bulk-delete-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Delete Multiple Games?</h3>
                <button class="modal-close" id="bulk-delete-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <span id="bulk-delete-count"></span> games? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="bulk-delete-cancel">Cancel</button>
                <button class="btn-delete" id="bulk-delete-confirm" style="background: #cc1122; border-color: #cc1122; color: #fff;">Delete All</button>
            </div>
        </div>
    </div>

    <!-- Category Change Modal -->
    <div class="modal-overlay" id="category-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Change Category</h3>
                <button class="modal-close" id="category-close">&times;</button>
            </div>
            <div class="modal-body">
                <label>Select category for <span id="category-game-count"></span> games:</label>
                <select class="filter-select" id="new-category-select" style="margin-top: 12px; width: 100%;">
                    <option value="uncategorized">Uncategorized</option>
                    <option value="favorites">Favorites</option>
                    <option value="horror">Horror</option>
                    <option value="action">Action</option>
                    <option value="puzzle">Puzzle</option>
                    <option value="survival">Survival</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="category-cancel">Cancel</button>
                <button class="btn-primary" id="category-confirm">Change Category</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="help-modal">
        <div class="modal-content help-modal">
            <div class="modal-header">
                <h3>Quick Help</h3>
                <button class="modal-close" id="help-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="help-section">
                    <h4>Keyboard Shortcuts</h4>
                    <div class="shortcuts-grid" id="shortcuts-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                <div class="help-section">
                    <h4>Tips for Better Games</h4>
                    <ul class="tips-list" id="tips-list">
                        <!-- Populated by JavaScript -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Version History Modal -->
    <div class="modal-overlay" id="version-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Version History</h3>
                <button class="modal-close" id="version-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="version-history" id="version-history">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div class="modal-overlay" id="edit-category-modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Edit Game</h3>
                <button class="modal-close" id="edit-category-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="customization-item" style="margin-bottom: 16px;">
                    <label>Game Title</label>
                    <input type="text" class="filter-select" id="edit-title-input" style="width: 100%;">
                </div>
                <div class="customization-item">
                    <label>Category</label>
                    <select class="filter-select" id="edit-category-select" style="width: 100%;">
                        <option value="uncategorized">Uncategorized</option>
                        <option value="favorites">Favorites</option>
                        <option value="horror">Horror</option>
                        <option value="action">Action</option>
                        <option value="puzzle">Puzzle</option>
                        <option value="survival">Survival</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="edit-cancel">Cancel</button>
                <button class="btn-primary" id="edit-save">Save Changes</button>
            </div>
        </div>
    </div>

    <script src="/js/sgai-components.js" defer></script>
    <script src="/js/state-bus.js" defer></script>
    <script src="/js/page-shell.js" defer></script>
    <script src="/js/ollama-integration.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const accessCheck = document.getElementById('access-check');
            const gamesContent = document.getElementById('games-content');
            const gamesGrid = document.getElementById('custom-games-grid');
            const emptyState = document.getElementById('empty-state');
            const noResults = document.getElementById('no-results');
            const categoryFilter = document.getElementById('category-filter');
            const searchInput = document.getElementById('search-input');
            const sortBtn = document.getElementById('sort-btn');
            const sortMenu = document.getElementById('sort-menu');
            const selectModeBtn = document.getElementById('select-mode-btn');
            const bulkActions = document.getElementById('bulk-actions');
            const selectionCount = document.getElementById('selection-count');

            let selectMode = false;
            let selectedGames = new Set();
            let currentSort = { by: 'created', order: 'desc' };
            let currentCategory = 'all';
            let currentSearch = '';
            let editingGameId = null;

            // Check if user has max tier
            if (!OllamaIntegration.hasMaxTier()) {
                accessCheck.innerHTML = `
                    <div class="access-denied">
                        <div class="access-denied-icon">üîí</div>
                        <h2>Premium Feature</h2>
                        <p>Custom Games is available exclusively for Elder God tier subscribers. Upgrade now to access your AI-generated games!</p>
                        <a href="/subscription.html" class="upgrade-btn">
                            <span>Upgrade to Elder God</span>
                            <span>üúè</span>
                        </a>
                    </div>
                `;
                return;
            }

            gamesContent.style.display = 'block';
            
            // Initialize
            loadCategories();
            loadGames();
            setupEventListeners();
            loadHelpContent();

            // ============ LOAD GAMES ============
            function loadGames() {
                let games = OllamaIntegration.getCustomGames();

                // Apply search
                if (currentSearch) {
                    games = OllamaIntegration.searchGames(currentSearch);
                }

                // Apply category filter
                if (currentCategory !== 'all') {
                    games = games.filter(g => g.category === currentCategory);
                }

                // Apply sort
                games = OllamaIntegration.sortGames(games, currentSort.by, currentSort.order);

                // Update category filter options
                const categories = OllamaIntegration.getCategories();
                categoryFilter.innerHTML = '<option value="all">All Categories</option>' +
                    categories.map(c => `<option value="${c}">${capitalizeFirst(c)}</option>`).join('');
                categoryFilter.value = currentCategory;

                // Show appropriate state
                if (games.length === 0) {
                    if (currentSearch || currentCategory !== 'all') {
                        gamesGrid.style.display = 'none';
                        emptyState.style.display = 'none';
                        noResults.style.display = 'block';
                    } else {
                        gamesGrid.style.display = 'none';
                        emptyState.style.display = 'block';
                        noResults.style.display = 'none';
                    }
                } else {
                    gamesGrid.style.display = 'grid';
                    emptyState.style.display = 'none';
                    noResults.style.display = 'none';
                    renderGames(games);
                }

                // Update category chips
                updateCategoryChips();
            }

            // ============ RENDER GAMES ============
            function renderGames(games) {
                gamesGrid.innerHTML = games.map(game => {
                    const validation = game.validation;
                    const scoreClass = validation?.score >= 80 ? 'excellent' : validation?.score >= 50 ? 'good' : 'poor';
                    const isSelected = selectedGames.has(game.id);
                    
                    return `
                    <div class="custom-game-card" data-id="${game.id}">
                        <div class="game-checkbox ${isSelected ? 'checked' : ''}" data-id="${game.id}"></div>
                        <button class="game-actions-menu" data-id="${game.id}">‚ãÆ</button>
                        <div class="game-actions-dropdown" id="actions-${game.id}">
                            <button class="game-action-item" data-action="play" data-id="${game.id}">‚ñ∂ Play</button>
                            <button class="game-action-item" data-action="edit" data-id="${game.id}">‚úèÔ∏è Edit</button>
                            <button class="game-action-item" data-action="export" data-id="${game.id}">üì• Export HTML</button>
                            <button class="game-action-item" data-action="versions" data-id="${game.id}">üìú Versions</button>
                            <button class="game-action-item danger" data-action="delete" data-id="${game.id}">üóëÔ∏è Delete</button>
                        </div>
                        <div class="custom-game-thumbnail">üéÆ</div>
                        <div class="custom-game-info">
                            <div class="custom-game-title">${escapeHtml(game.title)}</div>
                            <div class="custom-game-desc">${escapeHtml(game.description || 'Custom horror game')}</div>
                            <div class="custom-game-meta">
                                <span>${formatDate(game.createdAt)}</span>
                                ${validation ? `<span class="validation-score ${scoreClass}">${validation.score}%</span>` : ''}
                            </div>
                            ${game.category && game.category !== 'uncategorized' ? `
                            <div class="custom-game-meta">
                                <span class="category-chip" style="font-size: 10px; padding: 4px 8px;">${capitalizeFirst(game.category)}</span>
                            </div>
                            ` : ''}
                        </div>
                        <div class="custom-game-stats">
                            <div class="stat-item">
                                <span class="stat-label">Played</span>
                                <span class="stat-value">${game.playCount || 0}x</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">High Score</span>
                                <span class="stat-value">${game.highScore || 0}</span>
                            </div>
                        </div>
                        <div class="custom-game-actions">
                            <button class="btn-play" data-id="${game.id}">‚ñ∂ Play</button>
                            <button class="btn-delete" data-id="${game.id}" data-title="${escapeHtml(game.title)}">üóëÔ∏è</button>
                        </div>
                    </div>
                `}).join('');

                // Add event listeners
                setupGameCardListeners();
            }

            // ============ LOAD CATEGORIES ============
            function loadCategories() {
                const categories = OllamaIntegration.getCategories();
                updateCategoryChips();
            }

            function updateCategoryChips() {
                const chipsEl = document.getElementById('category-chips');
                const games = OllamaIntegration.getCustomGames();
                const categories = OllamaIntegration.getCategories();
                
                const counts = {};
                categories.forEach(c => counts[c] = 0);
                games.forEach(g => {
                    const cat = g.category || 'uncategorized';
                    counts[cat] = (counts[cat] || 0) + 1;
                });

                let html = `<button class="category-chip ${currentCategory === 'all' ? 'active' : ''}" data-category="all">All <span class="count">${games.length}</span></button>`;
                
                categories.forEach(cat => {
                    const count = counts[cat] || 0;
                    html += `<button class="category-chip ${currentCategory === cat ? 'active' : ''}" data-category="${cat}">${capitalizeFirst(cat)} <span class="count">${count}</span></button>`;
                });

                chipsEl.innerHTML = html;

                // Add click handlers
                chipsEl.querySelectorAll('.category-chip').forEach(chip => {
                    chip.addEventListener('click', function() {
                        currentCategory = this.dataset.category;
                        updateCategoryChips();
                        loadGames();
                    });
                });
            }

            // ============ SETUP EVENT LISTENERS ============
            function setupEventListeners() {
                // Search
                searchInput.addEventListener('input', debounce(function() {
                    currentSearch = this.value;
                    loadGames();
                }, 300));

                // Category filter
                categoryFilter.addEventListener('change', function() {
                    currentCategory = this.value;
                    loadGames();
                });

                // Sort menu
                sortBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    sortMenu.classList.toggle('open');
                });

                document.addEventListener('click', function() {
                    sortMenu.classList.remove('open');
                });

                sortMenu.querySelectorAll('.sort-option').forEach(option => {
                    option.addEventListener('click', function() {
                        currentSort = { by: this.dataset.sort, order: this.dataset.order };
                        document.querySelectorAll('.sort-option').forEach(o => o.classList.remove('active'));
                        this.classList.add('active');
                        document.getElementById('current-sort').textContent = this.textContent;
                        sortMenu.classList.remove('open');
                        loadGames();
                    });
                });

                // Select mode
                selectModeBtn.addEventListener('click', function() {
                    selectMode = !selectMode;
                    this.classList.toggle('active', selectMode);
                    if (!selectMode) {
                        selectedGames.clear();
                        updateBulkActions();
                        loadGames();
                    }
                });

                // Bulk cancel
                document.getElementById('bulk-cancel-btn').addEventListener('click', function() {
                    selectMode = false;
                    selectedGames.clear();
                    selectModeBtn.classList.remove('active');
                    updateBulkActions();
                    loadGames();
                });

                // Bulk delete
                document.getElementById('bulk-delete-btn').addEventListener('click', function() {
                    document.getElementById('bulk-delete-count').textContent = selectedGames.size;
                    document.getElementById('bulk-delete-modal').classList.add('active');
                });

                document.getElementById('bulk-delete-confirm').addEventListener('click', function() {
                    OllamaIntegration.deleteMultipleGames(Array.from(selectedGames));
                    selectedGames.clear();
                    selectMode = false;
                    selectModeBtn.classList.remove('active');
                    document.getElementById('bulk-delete-modal').classList.remove('active');
                    updateBulkActions();
                    loadGames();
                });

                document.getElementById('bulk-delete-close').addEventListener('click', function() {
                    document.getElementById('bulk-delete-modal').classList.remove('active');
                });

                document.getElementById('bulk-delete-cancel').addEventListener('click', function() {
                    document.getElementById('bulk-delete-modal').classList.remove('active');
                });

                // Bulk category
                document.getElementById('bulk-category-btn').addEventListener('click', function() {
                    document.getElementById('category-game-count').textContent = selectedGames.size;
                    document.getElementById('category-modal').classList.add('active');
                });

                document.getElementById('category-confirm').addEventListener('click', function() {
                    const newCategory = document.getElementById('new-category-select').value;
                    selectedGames.forEach(gameId => {
                        OllamaIntegration.updateGameCategory(gameId, newCategory);
                    });
                    selectedGames.clear();
                    selectMode = false;
                    selectModeBtn.classList.remove('active');
                    document.getElementById('category-modal').classList.remove('active');
                    updateBulkActions();
                    loadGames();
                });

                document.getElementById('category-close').addEventListener('click', function() {
                    document.getElementById('category-modal').classList.remove('active');
                });

                document.getElementById('category-cancel').addEventListener('click', function() {
                    document.getElementById('category-modal').classList.remove('active');
                });

                // Help modal
                document.getElementById('help-btn').addEventListener('click', function() {
                    document.getElementById('help-modal').classList.add('active');
                });

                document.getElementById('help-close').addEventListener('click', function() {
                    document.getElementById('help-modal').classList.remove('active');
                });

                // New game button
                document.getElementById('new-game-btn').addEventListener('click', function() {
                    window.location.href = '/ollama-builder.html';
                });

                // Clear filters
                document.getElementById('clear-filters-btn').addEventListener('click', function() {
                    currentSearch = '';
                    currentCategory = 'all';
                    searchInput.value = '';
                    loadGames();
                });

                // Modal close handlers
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.addEventListener('click', function(e) {
                        if (e.target === this) {
                            this.classList.remove('active');
                        }
                    });
                });

                // Delete modal handlers
                setupDeleteModal();
                
                // Edit modal handlers
                setupEditModal();
                
                // Version modal handlers
                setupVersionModal();
            }

            // ============ GAME CARD LISTENERS ============
            function setupGameCardListeners() {
                // Play buttons
                gamesGrid.querySelectorAll('.btn-play').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const gameId = this.dataset.id;
                        const game = OllamaIntegration.getGameById(gameId);
                        if (game) playGame(game);
                    });
                });

                // Delete buttons
                gamesGrid.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const gameId = this.dataset.id;
                        const gameTitle = this.dataset.title;
                        showDeleteModal(gameId, gameTitle);
                    });
                });

                // Checkboxes
                gamesGrid.querySelectorAll('.game-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const gameId = this.dataset.id;
                        if (selectedGames.has(gameId)) {
                            selectedGames.delete(gameId);
                            this.classList.remove('checked');
                        } else {
                            selectedGames.add(gameId);
                            this.classList.add('checked');
                        }
                        updateBulkActions();
                    });
                });

                // Actions menu
                gamesGrid.querySelectorAll('.game-actions-menu').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const gameId = this.dataset.id;
                        const dropdown = document.getElementById('actions-' + gameId);
                        
                        // Close other dropdowns
                        document.querySelectorAll('.game-actions-dropdown.open').forEach(d => {
                            if (d !== dropdown) d.classList.remove('open');
                        });
                        
                        dropdown.classList.toggle('open');
                    });
                });

                // Action items
                gamesGrid.querySelectorAll('.game-action-item').forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const action = this.dataset.action;
                        const gameId = this.dataset.id;
                        
                        // Close dropdown
                        document.getElementById('actions-' + gameId).classList.remove('open');
                        
                        const game = OllamaIntegration.getGameById(gameId);
                        
                        switch(action) {
                            case 'play':
                                if (game) playGame(game);
                                break;
                            case 'edit':
                                showEditModal(game);
                                break;
                            case 'export':
                                if (game) OllamaIntegration.exportGameAsHtml(game);
                                break;
                            case 'versions':
                                showVersionModal(game);
                                break;
                            case 'delete':
                                if (game) showDeleteModal(game.id, game.title);
                                break;
                        }
                    });
                });

                // Close dropdowns when clicking elsewhere
                document.addEventListener('click', function() {
                    document.querySelectorAll('.game-actions-dropdown.open').forEach(d => {
                        d.classList.remove('open');
                    });
                });
            }

            // ============ UPDATE BULK ACTIONS ============
            function updateBulkActions() {
                if (selectedGames.size > 0) {
                    bulkActions.style.display = 'flex';
                    selectionCount.textContent = selectedGames.size;
                } else {
                    bulkActions.style.display = 'none';
                }
            }

            // ============ DELETE MODAL ============
            function setupDeleteModal() {
                let gameIdToDelete = null;

                document.getElementById('delete-modal-close').addEventListener('click', function() {
                    document.getElementById('delete-modal').classList.remove('active');
                });

                document.getElementById('delete-cancel-btn').addEventListener('click', function() {
                    document.getElementById('delete-modal').classList.remove('active');
                });

                window.showDeleteModal = function(gameId, gameTitle) {
                    gameIdToDelete = gameId;
                    document.getElementById('delete-game-name').textContent = gameTitle;
                    document.getElementById('delete-modal').classList.add('active');
                };

                document.getElementById('delete-confirm-btn').addEventListener('click', function() {
                    if (gameIdToDelete) {
                        OllamaIntegration.deleteCustomGame(gameIdToDelete);
                        document.getElementById('delete-modal').classList.remove('active');
                        loadGames();
                    }
                });
            }

            // ============ EDIT MODAL ============
            function setupEditModal() {
                document.getElementById('edit-category-close').addEventListener('click', function() {
                    document.getElementById('edit-category-modal').classList.remove('active');
                });

                document.getElementById('edit-cancel').addEventListener('click', function() {
                    document.getElementById('edit-category-modal').classList.remove('active');
                });

                window.showEditModal = function(game) {
                    editingGameId = game.id;
                    document.getElementById('edit-title-input').value = game.title;
                    document.getElementById('edit-category-select').value = game.category || 'uncategorized';
                    document.getElementById('edit-category-modal').classList.add('active');
                };

                document.getElementById('edit-save').addEventListener('click', function() {
                    const newTitle = document.getElementById('edit-title-input').value.trim();
                    const newCategory = document.getElementById('edit-category-select').value;
                    
                    if (editingGameId && newTitle) {
                        OllamaIntegration.updateGame(editingGameId, {
                            title: newTitle,
                            category: newCategory
                        });
                        document.getElementById('edit-category-modal').classList.remove('active');
                        loadGames();
                    }
                });
            }

            // ============ VERSION MODAL ============
            function setupVersionModal() {
                document.getElementById('version-close').addEventListener('click', function() {
                    document.getElementById('version-modal').classList.remove('active');
                });

                window.showVersionModal = function(game) {
                    const historyEl = document.getElementById('version-history');
                    
                    if (!game.versions || game.versions.length === 0) {
                        historyEl.innerHTML = '<p>No version history available.</p>';
                    } else {
                        historyEl.innerHTML = game.versions.slice().reverse().map(v => `
                            <div class="version-item">
                                <div class="version-info">
                                    <div class="version-id">${v.id}</div>
                                    <div class="version-date">${formatDate(v.createdAt)}</div>
                                </div>
                                <button class="version-restore" data-version-id="${v.id}" data-game-id="${game.id}">Restore</button>
                            </div>
                        `).join('');

                        // Add restore handlers
                        historyEl.querySelectorAll('.version-restore').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const versionId = this.dataset.versionId;
                                const gameId = this.dataset.gameId;
                                const game = OllamaIntegration.getGameById(gameId);
                                const version = game.versions.find(v => v.id === versionId);
                                
                                if (version) {
                                    OllamaIntegration.saveGameVersion(gameId, version.html);
                                    OllamaIntegration.updateGame(gameId, { html: version.html });
                                    document.getElementById('version-modal').classList.remove('active');
                                    loadGames();
                                }
                            });
                        });
                    }
                    
                    document.getElementById('version-modal').classList.add('active');
                };
            }

            // ============ LOAD HELP CONTENT ============
            function loadHelpContent() {
                // Keyboard shortcuts
                const shortcuts = OllamaIntegration.getKeyboardShortcuts();
                const shortcutsGrid = document.getElementById('shortcuts-grid');
                shortcutsGrid.innerHTML = Object.entries(shortcuts).map(([key, desc]) => `
                    <div class="shortcut-item">
                        <span class="shortcut-key">${key}</span>
                        <span class="shortcut-desc">${desc}</span>
                    </div>
                `).join('');

                // Tips
                const tips = OllamaIntegration.getPromptTips();
                const tipsList = document.getElementById('tips-list');
                tipsList.innerHTML = tips.map(tip => `<li>${tip}</li>`).join('');
            }

            // ============ GAME PLAYER ============
            const gamePlayer = document.getElementById('game-player');
            const gameFrame = document.getElementById('game-frame');
            const playerTitle = document.getElementById('player-title');
            const playerClose = document.getElementById('player-close');

            window.playGame = function(game) {
                playerTitle.textContent = game.title;
                
                const sanitizedHtml = OllamaIntegration.sanitizeGameHtml(game.html);
                const blob = new Blob([sanitizedHtml], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                
                gameFrame.src = url;
                gamePlayer.style.display = 'block';
                
                OllamaIntegration.updateGameStats(game.id, { played: true });
                loadGames();
            };

            playerClose.addEventListener('click', function() {
                gamePlayer.style.display = 'none';
                gameFrame.src = '';
            });
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>
